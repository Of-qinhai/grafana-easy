apiVersion: 1

templates:
  - orgId: 1
    name: feishu_card
    template: |
      {
        "msg_type": "interactive",
        "card": {
          "schema": "2.0",
          "config": {
            "update_multi": true
          },
          "header": {
            "title": {
              "tag": "plain_text",
              "content": {{ if .CommonAnnotations.customTitle }}{{ printf "%q" .CommonAnnotations.customTitle }}{{ else }}{{ printf "%q" .GroupLabels.alertname }}{{ end }}
            },
            "icon": {
              "tag": "standard_icon",
              "token": "platform_outlined"
            },
            "text_tag_list": [
              {
                "tag": "text_tag",
                "text": {
                  "tag": "plain_text",
                  "content": {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}{{ printf "%q" "Á¥ßÊÄ•" }}{{ else }}{{ printf "%q" "ÂëäË≠¶" }}{{ end }}{{ else }}{{ printf "%q" "Â∑≤ÊÅ¢Â§ç" }}{{ end }}
                },
                "color": {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}{{ printf "%q" "red" }}{{ else }}{{ printf "%q" "orange" }}{{ end }}{{ else }}{{ printf "%q" "green" }}{{ end }}
              }
            ],
            "template": {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}{{ printf "%q" "red" }}{{ else }}{{ printf "%q" "orange" }}{{ end }}{{ else }}{{ printf "%q" "green" }}{{ end }},
            "padding": "12px 8px 12px 8px"
          },
          "body": {
            "direction": "vertical",
            "elements": [
              {
                "tag": "column_set",
                "flex_mode": "stretch",
                "horizontal_spacing": "12px",
                "horizontal_align": "left",
                "columns": [
                  {
                    "tag": "column",
                    "width": "weighted",
                    "weight": 1,
                    "elements": [
                      {
                        "tag": "markdown",
                        "content": {{ if .CommonAnnotations.ruleUid }}{{ printf "%q" (printf "**ÂëäË≠¶ÊåáÊ†á**\n[%s](%salerting/grafana/%s/view)" .CommonAnnotations.metricName .ExternalURL .CommonAnnotations.ruleUid) }}{{ else }}{{ printf "%q" (printf "**ÂëäË≠¶ÊåáÊ†á**\n%s" .CommonAnnotations.metricName) }}{{ end }}
                      }
                    ],
                    "vertical_spacing": "8px",
                    "horizontal_align": "left",
                    "vertical_align": "top"
                  },
                  {
                    "tag": "column",
                    "width": "weighted",
                    "weight": 1,
                    "elements": [
                      {
                        "tag": "markdown",
                        "content": {{ if gt (len .Alerts) 0 }}{{ with index .Alerts 0 }}{{ printf "%q" (printf "**Ëß¶ÂèëÊó∂Èó¥**\n%s" ((.StartsAt.Add 28800000000000).Format "2006-01-02 15:04:05")) }}{{ end }}{{ else }}{{ printf "%q" "**Ëß¶ÂèëÊó∂Èó¥**\nÊöÇÊó†Êï∞ÊçÆ" }}{{ end }}
                      }
                    ],
                    "vertical_spacing": "8px",
                    "horizontal_align": "left",
                    "vertical_align": "top"
                  }
                ],
                "margin": "0px 0px 0px 0px"
              }{{ if eq .Status "firing" }},
              {
                "tag": "column_set",
                "flex_mode": "stretch",
                "horizontal_spacing": "12px",
                "horizontal_align": "left",
                "columns": [
                  {
                    "tag": "column",
                    "width": "weighted",
                    "weight": 1,
                    "background_style": "grey-50",
                    "elements": [
                      {
                        "tag": "markdown",
                        "content": {{ if .CommonLabels.severity }}{{ if eq .CommonLabels.severity "critical" }}{{ printf "%q" "## <font color='red'>‰∏•Èáç</font>" }}{{ else if eq .CommonLabels.severity "warning" }}{{ printf "%q" "## <font color='orange'>Ë≠¶Âëä</font>" }}{{ else }}{{ printf "%q" (printf "## <font color='grey'>%s</font>" .CommonLabels.severity) }}{{ end }}{{ else }}{{ printf "%q" "## <font color='orange'>Ë≠¶Âëä</font>" }}{{ end }},
                        "text_align": "center"
                      },
                      {
                        "tag": "markdown",
                        "content": "<font color='grey'>ÂëäË≠¶Á∫ßÂà´</font>",
                        "text_align": "center",
                        "text_size": "normal"
                      }
                    ],
                    "padding": "12px 12px 12px 12px",
                    "vertical_spacing": "2px",
                    "horizontal_align": "left",
                    "vertical_align": "top"
                  },
                  {
                    "tag": "column",
                    "width": "weighted",
                    "weight": 1,
                    "background_style": "grey-50",
                    "elements": [
                      {
                        "tag": "markdown",
                        "content": {{ if gt (len .Alerts) 0 }}{{ $maxValue := 0.0 }}{{ $hasValue := false }}{{ range .Alerts }}{{ if .Values }}{{ $v := index .Values "A" }}{{ if not $v }}{{ $v = index .Values "B0" }}{{ end }}{{ if not $v }}{{ $v = index .Values "B" }}{{ end }}{{ if $v }}{{ if or (not $hasValue) (gt $v $maxValue) }}{{ $maxValue = $v }}{{ $hasValue = true }}{{ end }}{{ end }}{{ end }}{{ end }}{{ if $hasValue }}{{ $unit := "" }}{{ if $.CommonAnnotations.unit }}{{ $unit = $.CommonAnnotations.unit }}{{ end }}{{ if ge $maxValue 10.0 }}{{ if ge $maxValue 80.0 }}{{ printf "%q" (printf "## <font color='red'>%.0f%s</font>" $maxValue $unit) }}{{ else if ge $maxValue 50.0 }}{{ printf "%q" (printf "## <font color='orange'>%.0f%s</font>" $maxValue $unit) }}{{ else }}{{ printf "%q" (printf "## <font color='blue'>%.0f%s</font>" $maxValue $unit) }}{{ end }}{{ else if ge $maxValue 1.0 }}{{ if ge $maxValue 5.0 }}{{ printf "%q" (printf "## <font color='orange'>%.1f%s</font>" $maxValue $unit) }}{{ else }}{{ printf "%q" (printf "## <font color='blue'>%.1f%s</font>" $maxValue $unit) }}{{ end }}{{ else if ge $maxValue 0.01 }}{{ if ge $maxValue 0.8 }}{{ printf "%q" (printf "## <font color='red'>%.2f%s</font>" $maxValue $unit) }}{{ else if ge $maxValue 0.5 }}{{ printf "%q" (printf "## <font color='orange'>%.2f%s</font>" $maxValue $unit) }}{{ else }}{{ printf "%q" (printf "## <font color='blue'>%.2f%s</font>" $maxValue $unit) }}{{ end }}{{ else }}{{ if ge $maxValue 0.008 }}{{ printf "%q" (printf "## <font color='red'>%.4f%s</font>" $maxValue $unit) }}{{ else if ge $maxValue 0.005 }}{{ printf "%q" (printf "## <font color='orange'>%.4f%s</font>" $maxValue $unit) }}{{ else }}{{ printf "%q" (printf "## <font color='blue'>%.4f%s</font>" $maxValue $unit) }}{{ end }}{{ end }}{{ else }}{{ printf "%q" "## <font color='grey'>-" }}{{ end }}{{ else }}{{ printf "%q" "## <font color='grey'>-" }}{{ end }},
                        "text_align": "center"
                      },
                      {
                        "tag": "markdown",
                        "content": {{ if .CommonAnnotations.threshold }}{{ printf "%q" (printf "<font color='grey'>ÈòàÂÄº: %s</font>" .CommonAnnotations.threshold) }}{{ else }}{{ printf "%q" "<font color='grey'>ÂΩìÂâçÂÄº</font>" }}{{ end }},
                        "text_align": "center",
                        "text_size": "normal"
                      }
                    ],
                    "padding": "12px 12px 12px 12px",
                    "vertical_spacing": "2px",
                    "horizontal_align": "left",
                    "vertical_align": "top"
                  },
                  {
                    "tag": "column",
                    "width": "weighted",
                    "weight": 1,
                    "background_style": "grey-50",
                    "elements": [
                      {
                        "tag": "markdown",
                        "content": {{ $count := len .Alerts }}{{ if eq .CommonLabels.severity "critical" }}{{ printf "%q" (printf "## <font color='red'>%dÊ¨°</font>" $count) }}{{ else }}{{ if ge $count 3 }}{{ printf "%q" (printf "## <font color='red'>%dÊ¨°</font>" $count) }}{{ else }}{{ printf "%q" (printf "## <font color='orange'>%dÊ¨°</font>" $count) }}{{ end }}{{ end }},
                        "text_align": "center"
                      },
                      {
                        "tag": "markdown",
                        "content": {{ $count := len .Alerts }}{{ if eq .CommonLabels.severity "critical" }}{{ printf "%q" "<font color='grey'>‰∏•Èáç ¬∑ Ëß¶ÂèëÊ¨°Êï∞</font>" }}{{ else }}{{ if ge $count 3 }}{{ printf "%q" "<font color='grey'>‰∏•Èáç ¬∑ Ëß¶ÂèëÊ¨°Êï∞</font>" }}{{ else }}{{ printf "%q" "<font color='grey'>ÂëäË≠¶ ¬∑ Ëß¶ÂèëÊ¨°Êï∞</font>" }}{{ end }}{{ end }},
                        "text_align": "center",
                        "text_size": "normal"
                      }
                    ],
                    "padding": "12px 12px 12px 12px",
                    "vertical_spacing": "2px",
                    "horizontal_align": "left",
                    "vertical_align": "top"
                  }
                ],
                "margin": "8px 0px 8px 0px"
              }{{ end }},
              {
                "tag": "markdown",
                "content": {{ printf "%q" (printf "**ÂëäË≠¶ÊèèËø∞**\n%s" .CommonAnnotations.description) }},
                "margin": "4px 0px 4px 0px"
              },
              {
                "tag": "markdown",
                "content": {{ printf "%q" (printf "**Âª∫ËÆÆÊìç‰Ωú**\n%s" .CommonAnnotations.summary) }},
                "margin": "4px 0px 4px 0px"
              },
              {
                "tag": "markdown",
                "content": {{ printf "%q" "**Áõ∏ÂÖ≥‰∫∫Âëò**\n " }},
                "margin": "4px 0px 4px 0px"
              },
              {
                "tag": "column_set",
                "flex_mode": "stretch",
                "horizontal_spacing": "8px",
                "horizontal_align": "left",
                "columns": [
                  {
                    "tag": "column",
                    "width": "auto",
                    "elements": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "Êü•ÁúãGrafanaÈù¢Êùø"
                        },
                        "type": "primary_filled",
                        "width": "default",
                        "behaviors": [
                          {
                            "type": "open_url",
                            "default_url": {{ printf "%q" (printf "%sa/grafana-metricsdrilldown-app/drilldown?from=now-1h&to=now&timezone=browser&var-metrics_filters=&var-filters=&var-labelsWingman=&layout=grid&filters-rule=&filters-prefix=&filters-suffix=&search_txt=&var-metrics-reducer-sort-by=default&filters-recent=&var-ds=prometheus&var-other_metric_filters=&metric=%s&actionView=breakdown&var-groupby=$__all&breakdownLayout=grid" .ExternalURL .CommonAnnotations.metricName) }}
                          }
                        ],
                        "margin": "4px 0px 4px 0px"
                      }
                    ],
                    "vertical_spacing": "8px",
                    "horizontal_align": "left",
                    "vertical_align": "top"
                  }
                ],
                "margin": "8px 0px 0px 0px"
              }
            ]
          }
        }
      }
  - orgId: 1
    name: __email_subject
    template: |
      {{- if eq .Status "firing" -}}
        {{- if eq .CommonLabels.severity "critical" -}}[Á¥ßÊÄ•ÂëäË≠¶]{{- else -}}[ÂëäË≠¶ÈÄöÁü•]{{- end -}}
      {{- else -}}[ÂëäË≠¶Â∑≤ÊÅ¢Â§ç]{{- end -}}
      {{- if .CommonAnnotations.customTitle }} {{ .CommonAnnotations.customTitle }}{{- else }} {{ .GroupLabels.alertname }}{{- end -}}
  - orgId: 1
    name: __email_alert_text
    template: |
      <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; max-width: 650px; margin: 20px auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.12); border: 1px solid #e8e8e8;">
        <div style="padding: 24px 24px 20px 24px; {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);{{ else }}background: linear-gradient(135deg, #fa8c16 0%, #ffa940 100%);{{ end }}{{ else }}background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);{{ end }} color: white; position: relative;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; background-color: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                {{ if eq .Status "firing" }}üî•{{ else }}‚úÖ{{ end }}
              </div>
              <div>
                <h1 style="margin: 0; font-size: 22px; font-weight: 600; line-height: 1.3;">
                  {{ if .CommonAnnotations.customTitle }}{{ .CommonAnnotations.customTitle }}{{ else }}{{ .GroupLabels.alertname }}{{ end }}
                </h1>
              </div>
            </div>
            <span style="display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; background-color: rgba(255,255,255,0.95); {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}color: #ff4d4f;{{ else }}color: #fa8c16;{{ end }}{{ else }}color: #52c41a;{{ end }} box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}Á¥ßÊÄ•{{ else }}ÂëäË≠¶{{ end }}{{ else }}Â∑≤ÊÅ¢Â§ç{{ end }}
            </span>
          </div>
        </div>
      
        <div style="padding: 24px;">
          <div style="display: flex; gap: 16px; margin-bottom: 24px; padding: 16px; background-color: #fafafa; border-radius: 8px; border-left: 4px solid {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}#ff4d4f{{ else }}#fa8c16{{ end }}{{ else }}#52c41a{{ end }};">
            <div style="flex: 1;">
              <div style="font-size: 12px; color: #8c8c8c; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">ÂëäË≠¶ÊåáÊ†á</div>
              <div style="font-size: 16px; font-weight: 600; color: #262626;">
                {{ if .CommonAnnotations.ruleUid }}
                  <a href="{{ .ExternalURL }}alerting/grafana/{{ .CommonAnnotations.ruleUid }}/view" style="color: #1890ff; text-decoration: none; border-bottom: 1px solid #1890ff;">{{ .CommonAnnotations.metricName }}</a>
                {{ else }}
                  {{ .CommonAnnotations.metricName }}
                {{ end }}
              </div>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 12px; color: #8c8c8c; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Ëß¶ÂèëÊó∂Èó¥</div>
              <div style="font-size: 16px; font-weight: 600; color: #262626;">
                {{ if gt (len .Alerts) 0 }}{{ with index .Alerts 0 }}{{ (.StartsAt.Add 28800000000000).Format "2006-01-02 15:04:05" }}{{ end }}{{ else }}ÊöÇÊó†Êï∞ÊçÆ{{ end }}
              </div>
            </div>
          </div>
      
          {{ if eq .Status "firing" }}
          <style>
            @media (max-width: 600px) {
              .alert-cards-container { flex-direction: column !important; }
              .alert-card { margin-bottom: 12px; }
            }
          </style>
          <div class="alert-cards-container" style="display: flex; gap: 12px; margin: 24px 0;">
            <div class="alert-card" style="flex: 1; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); padding: 20px 16px; border-radius: 10px; text-align: center; border: 2px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
              <div style="font-size: 28px; font-weight: 700; margin-bottom: 6px; {{ if .CommonLabels.severity }}{{ if eq .CommonLabels.severity "critical" }}color: #ff4d4f;{{ else if eq .CommonLabels.severity "warning" }}color: #fa8c16;{{ else }}color: #8c8c8c;{{ end }}{{ else }}color: #fa8c16;{{ end }}">
                {{ if .CommonLabels.severity }}{{ if eq .CommonLabels.severity "critical" }}‰∏•Èáç{{ else if eq .CommonLabels.severity "warning" }}Ë≠¶Âëä{{ else }}{{ .CommonLabels.severity }}{{ end }}{{ else }}Ë≠¶Âëä{{ end }}
              </div>
              <div style="font-size: 11px; color: #8c8c8c; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">ÂëäË≠¶Á∫ßÂà´</div>
            </div>
            <div class="alert-card" style="flex: 1; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); padding: 20px 16px; border-radius: 10px; text-align: center; border: 2px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
              <div style="font-size: 28px; font-weight: 700; margin-bottom: 6px; {{ if gt (len .Alerts) 0 }}{{ $maxValue := 0.0 }}{{ $hasValue := false }}{{ range .Alerts }}{{ if .Values }}{{ $v := index .Values "A" }}{{ if not $v }}{{ $v = index .Values "B0" }}{{ end }}{{ if not $v }}{{ $v = index .Values "B" }}{{ end }}{{ if $v }}{{ if or (not $hasValue) (gt $v $maxValue) }}{{ $maxValue = $v }}{{ $hasValue = true }}{{ end }}{{ end }}{{ end }}{{ end }}{{ if $hasValue }}{{ if ge $maxValue 80.0 }}color: #ff4d4f;{{ else if ge $maxValue 50.0 }}color: #fa8c16;{{ else if ge $maxValue 10.0 }}color: #1890ff;{{ else if ge $maxValue 5.0 }}color: #fa8c16;{{ else if ge $maxValue 1.0 }}color: #1890ff;{{ else if ge $maxValue 0.8 }}color: #ff4d4f;{{ else if ge $maxValue 0.5 }}color: #fa8c16;{{ else if ge $maxValue 0.008 }}color: #1890ff;{{ else if ge $maxValue 0.005 }}color: #ff4d4f;{{ else }}color: #1890ff;{{ end }}{{ else }}color: #8c8c8c;{{ end }}{{ else }}color: #8c8c8c;{{ end }}">
                {{ if gt (len .Alerts) 0 }}{{ $maxValue := 0.0 }}{{ $hasValue := false }}{{ range .Alerts }}{{ if .Values }}{{ $v := index .Values "A" }}{{ if not $v }}{{ $v = index .Values "B0" }}{{ end }}{{ if not $v }}{{ $v = index .Values "B" }}{{ end }}{{ if $v }}{{ if or (not $hasValue) (gt $v $maxValue) }}{{ $maxValue = $v }}{{ $hasValue = true }}{{ end }}{{ end }}{{ end }}{{ end }}{{ if $hasValue }}{{ $unit := "" }}{{ if .CommonAnnotations.unit }}{{ $unit = .CommonAnnotations.unit }}{{ end }}{{ if ge $maxValue 10.0 }}{{ printf "%.0f%s" $maxValue $unit }}{{ else if ge $maxValue 1.0 }}{{ printf "%.1f%s" $maxValue $unit }}{{ else if ge $maxValue 0.01 }}{{ printf "%.2f%s" $maxValue $unit }}{{ else }}{{ printf "%.4f%s" $maxValue $unit }}{{ end }}{{ else }}-{{ end }}{{ else }}-{{ end }}
              </div>
              <div style="font-size: 11px; color: #8c8c8c; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">{{ if .CommonAnnotations.threshold }}ÈòàÂÄº: {{ .CommonAnnotations.threshold }}{{ else }}ÂΩìÂâçÂÄº{{ end }}</div>
            </div>
            <div class="alert-card" style="flex: 1; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); padding: 20px 16px; border-radius: 10px; text-align: center; border: 2px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
              <div style="font-size: 28px; font-weight: 700; margin-bottom: 6px; {{ $count := len .Alerts }}{{ if eq .CommonLabels.severity "critical" }}color: #ff4d4f;{{ else }}{{ if ge $count 3 }}color: #ff4d4f;{{ else }}color: #fa8c16;{{ end }}{{ end }}">
                {{ len .Alerts }}Ê¨°
              </div>
              <div style="font-size: 11px; color: #8c8c8c; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">{{ $count := len .Alerts }}{{ if eq .CommonLabels.severity "critical" }}‰∏•ÈáçËß¶Âèë{{ else }}{{ if ge $count 3 }}‰∏•ÈáçËß¶Âèë{{ else }}ÂëäË≠¶Ëß¶Âèë{{ end }}{{ end }}</div>
            </div>
          </div>
          {{ end }}
      
          <div style="margin: 24px 0; padding: 16px; background-color: #f6f8fa; border-radius: 8px; border-left: 3px solid #1890ff;">
            <div style="font-weight: 700; margin-bottom: 10px; color: #262626; font-size: 14px;">
              ÂëäË≠¶ÊèèËø∞
            </div>
            <div style="color: #595959; line-height: 1.7; font-size: 14px;">{{ .CommonAnnotations.description }}</div>
          </div>
      
          <div style="margin: 24px 0; padding: 16px; background-color: #fffbe6; border-radius: 8px; border-left: 3px solid #faad14;">
            <div style="font-weight: 700; margin-bottom: 10px; color: #262626; font-size: 14px;">
              Âª∫ËÆÆÊìç‰Ωú
            </div>
            <div style="color: #595959; line-height: 1.7; font-size: 14px;">{{ .CommonAnnotations.summary }}</div>
          </div>
      
          <div style="text-align: center; margin-top: 28px;">
            <a href="{{ .ExternalURL }}a/grafana-metricsdrilldown-app/drilldown?from=now-1h&to=now&metric={{ .CommonAnnotations.metricName }}" style="display: inline-block; padding: 12px 28px; background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(24,144,255,0.3); transition: all 0.3s;">
              Êü•Áúã Grafana Èù¢Êùø
            </a>
          </div>
        </div>
      
        <div style="padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); text-align: center; font-size: 12px; color: #8c8c8c; border-top: 1px solid #e8e8e8;">
          <div style="margin-bottom: 4px;">Ê≠§ÈÇÆ‰ª∂Áî± Grafana Ëá™Âä®ÂèëÈÄÅ</div>
          <div style="color: #bfbfbf;">{{ .ExternalURL }}</div>
        </div>
      </div>
